TY.namespace("ui"),TY.loadedModule("TY.ui.draft"),function(t){function a(t,a){return t=t.replace(/{(.*?)}/gm,function(t,i){return a.hasOwnProperty(i)?a[i]:t})}function i(t){TY.loader("Qing.ui.tips",function(){new TY.ui.tips({el:t.el||null,type:t.type||"success",msg:t.msg,position:"midCenter",time:t.time||3e3,callback:function(){"function"==typeof t.cb?t.cb():void 0}})})}var e={wrapperTpl:['<div id="TY_ui_draft" class="TY-ui-draft clearfix">','<div class="draft-box">','<div class="hd cf">','<h4>您还可以保存<span class="remain-num"></span>份草稿</h4>','<a class="toggle-help-box" href="javascript:;" title="帮助">帮助</a>',"</div>",'<div class="bd">','<ul class="draft-list"></ul>',"</div>","</div>",'<div class="help-box">','<div class="hd cf">','<a class="toggle-draft-box" href="javascript:;" title="返回">返回</a>',"</div>",'<div class="bd">','<dl class="help-list">',"<dt>草稿箱介绍：</dt>","<dd>&middot;每个草稿箱可保存50份草稿</dd>","<dd>&middot;草稿需要手动保存</dd>","<dd>&middot;审核不通过的帖子也会打回到草稿箱中</dd>","<dd>&middot;草稿只保存标题和正文（专辑、投票等内容不做保存）</dd>","<dd>&middot;草稿箱如果存满请手动删除</dd>","</dl>","<p>希望小小的功能能给您带来一些些帮助</p>",'<p class="tr">——致力关心网友的涯叔</p>',"</div>","</div>","</div>"].join(""),itemTpl:['<li data-id="{id}">','<p class="cf"><span class="fl">{time}</span><span class="fr oper"><a class="del-btn" href="javascript:;">删除</a>　<a class="edit-btn" href="javascript:;">编辑</a></span></p>','<p>{state}<span class="title">{title}</span>&nbsp;{content}</p>',"</li>"].join("")};TY.ui.draft=function(t){this.init(t)},t.extend(TY.ui.draft.prototype,{init:function(a){this.$el=a.$el||t("<button></button>"),this.$title=a.$title||t("<input />"),this.$textarea=a.$textarea||t("<textarea></textarea>"),this.$save=a.$save||t("<button></button>"),this.$draft=t(e.wrapperTpl),this.editing="",this.useProxy=a.useProxy||!1,this.useProxy&&(this.proxyArgs={name:"bbsProxy",path:"http://bbs.tianya.cn/proxy.html"}),this.setPosition(),this.bindEvents()},setPosition:function(){var a=this;this.$textarea.wrap(t("<div></div>").css({position:"relative",width:TY.util.getElRealSize(a.$textarea).width,height:TY.util.getElRealSize(a.$textarea).height,"z-index":t.browser.msie&&t.browser.version<=7?"100":""})).after(this.$draft.css({top:0,right:0,height:TY.util.getElRealSize(this.$textarea).height-22}))},bindEvents:function(){var a=this;this.$el.bind("click",function(){a.$draft.toggle()}).one("click",function(){a.getDraftList()}),this.$save.bind("click",function(){a.saveDraft()}),this.$textarea.bind("focus",function(){"block"===a.$draft.css("display")&&a.$draft.hide()}),t(".toggle-help-box, .toggle-draft-box",a.$draft).bind("click",function(){t(".draft-box, .help-box",a.$draft).toggle()}),t(".draft-list",a.$draft).delegate(".del-btn","click",function(){a.delDraft(t(this).closest("li").data("id"))}),t(".draft-list",a.$draft).delegate(".edit-btn","click",function(i){t.trim(a.$title.val())||t.trim(a.$textarea.val())?new TY.ui.pop({body:"是否编辑当前草稿？（将会丢失当前编辑的内容）",yesHandler:function(){a.editDraft(t(i.target).closest("li").data("id"))}}):a.editDraft(t(i.target).closest("li").data("id"))})},getDraftList:function(){function i(i){if(i&&1==i.success){for(var n,r=i.data.draftBoxRemain,d=i.data.draftBoxList,o="",l=0;l<d.length;l++)n=d[l],o+=a(e.itemTpl,{id:n.uuid,time:n.modifyTime,state:-3===n.state?'<span style="color:#f00;">[审核打回]</span>':"",title:n.title||"[无标题]",content:n.content});t(".remain-num",s.$draft).html(r),t(".draft-list",s.$draft).html(o)}}var s=this;this.useProxy?new TY.util.proxy({name:this.proxyArgs.name,path:this.proxyArgs.path},"getJSON","http://bbs.tianya.cn/api?method=bbs.api.queryUserDraftBox",function(t){i(t)}):t.getJSON("/api?method=bbs.api.queryUserDraftBox",function(t){i(t)})},saveDraft:function(){function a(t){t&&1==t.success?(e.editing||(e.editing=t.data.uuid),i({el:e.$textarea,type:"success",msg:"保存草稿成功！"}),e.getDraftList()):i({el:e.$textarea,type:"warn",msg:t.message||"保存草稿失败，请确认您的网络是否正常？"})}var e=this,s=t.trim(this.$title.val()),n=t.trim(this.$textarea.val()),r={};return n?(r=this.editing?{method:"bbs.api.updateDraftBox","params.draftBoxId":this.editing,"params.title":s,"params.content":n}:{method:"bbs.api.saveDraftBox","params.title":s,"params.content":n},void(this.useProxy?new TY.util.proxy({name:this.proxyArgs.name,path:this.proxyArgs.path},"post","http://bbs.tianya.cn/api?",r,function(t){a(t)},"json"):t.post("/api?",r,function(t){a(t)},"json"))):void i({el:this.$textarea,type:"info",msg:"草稿的内容不能为空！"})},delDraft:function(a){function e(e){e&&1==e.success?(t("li[data-id='"+a+"']",s.$draft).slideUp(200,function(){t(this).remove()}),t(".remain-num",s.$draft).html(function(){return+t(this).text()+1}),n&&(s.editing="",s.$title.val(""),s.$textarea.val(""))):i({el:s.$textarea,type:"warn",msg:e.message||"删除草稿失败，请确认您的网络是否正常？"})}var s=this,n=a===this.editing,r={method:"bbs.api.delDraftBox","params.draftBoxId":a};new TY.ui.pop({body:"是否删除草稿？"+(n?"（该草稿当前处于编辑状态）":""),yesHandler:function(){s.useProxy?new TY.util.proxy({name:s.proxyArgs.name,path:s.proxyArgs.path},"getJSON","http://bbs.tianya.cn/api?"+t.param(r),function(t){e(t)}):t.getJSON("/api?"+t.param(r),function(t){e(t)})}})},editDraft:function(a){function e(t){t&&1==t.success?(s.editing=a,s.$title.val(t.data.draftBox.title),s.$textarea.val(t.data.draftBox.content),s.$draft.hide()):i({el:s.$textarea,type:"warn",msg:t.message||"查询草稿失败，请确认您的网络是否正常？"})}var s=this,n={method:"bbs.api.querySpecifyDraftBox","params.draftBoxId":a};this.useProxy?new TY.util.proxy({name:this.proxyArgs.name,path:this.proxyArgs.path},"getJSON","http://bbs.tianya.cn/api?"+t.param(n),function(t){e(t)}):t.getJSON("/api?"+t.param(n),function(t){e(t)})}})}(jQuery);