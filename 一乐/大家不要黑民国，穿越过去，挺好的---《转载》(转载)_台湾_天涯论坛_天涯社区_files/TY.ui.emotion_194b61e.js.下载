TY.loadedModule("TY.ui.emotion"),function(t){function i(t,i){return t=t.replace(/{(.*?)}/gm,function(t,e){return i.hasOwnProperty(e)?i[e]:t})}var e={wrapperTpl:['<div class="TY-ui-emotion">','<div class="arrow"><div class="outer"></div><div class="inner"></div></div>','<div class="hd">{hd}</div>','<div class="bd">','<div class="emot-cont"><div class="emot-cont-pkg">{cont}</div></div>','<div class="emot-tab"><ul class="emot-tab-list clearfix">{tab}</ul></div>',"</div>",'<div class="ft"></div>',"</div>"].join(""),tabTpl:'<li><a class="{curr}" href="javascript:;" data-pkg="{pkg}">{name}</a></li>',contTpl:'<li title="{name}" data-img="{img}" data-gif="{gif}" data-code="{code}"><img alt="{name}" src="{img}" /></li>'};TY.ui.emotion=function(t){var i=this,e=arguments;"object"==typeof TY_util_emotion?this.init(t):setTimeout(function(){e.callee.call(i,t)},500)},t.extend(TY.ui.emotion.prototype,{init:function(i){var e=this,o={$el:null,$textarea:null,left:0,top:0,arrowLeft:0,render:null,callback:null};this.args=t.extend({},o,i),this.args.$el?this.args.$el.data("init")||(this.args.$el.data("init",!0),this.args.$el.one("click",function(){e.createHtml()})):TY.util.console("You have not defined the emotion click element.")},createHtml:function(){var o=this,n="",a="",s="",l=TY_util_emotion.getMapList();t.each(l,function(t,s){n+=i(e.tabTpl,{pkg:t,name:s.name,curr:s["default"]?"curr":""}),s["default"]&&(a+=o.createEmotPkgHtml(t))}),s=i(e.wrapperTpl,{hd:TY_util_emotion.getVipFlag()?"":'<div class="open-vip-tips cf"><span>开通VIP会员，体验个性化表情</span>　<a class="open-vip-btn" href="javascript:;">立即开通</a>　<a class="fr" href="http://www.tianya.cn/vip/" target="_blank">查看更多特权</a></div>',cont:a,tab:n}),this.$emotion=t(s).appendTo("body"),t(".emot-cont",this.$emotion).scrollbar(),this.setPosition(),this.bindEvents(),t.isFunction(this.args.render)&&this.args.render()},createEmotPkgHtml:function(o){var n=TY_util_emotion.getRootPath(),a=TY_util_emotion.getMapList()[o],s="";return a&&(s+='<ul class="'+a.size+' clearfix">',t.each(a.list,function(t,a){s+=i(e.contTpl,{name:t,code:o+":"+t,img:n+o+"/"+a.en+".png",gif:n+o+"/"+a.en+".gif"})}),s+="</ul>"),s},setPosition:function(){var i,e,o=this.args.$el.offset(),n=TY.util.getElRealSize(this.args.$el),a=TY.util.getElRealSize(this.$emotion);i=o.left-(a.width-n.width)/2+this.args.left,e=o.top+n.height+this.args.top+8,0>i&&(i=0),i+a.width>t(window).width()&&(i=t(window).width()-a.width),this.$emotion.css({top:e,left:i}).find(".arrow").css({marginLeft:this.args.arrowLeft})},insertEmotionCode:function(i){var e="",o="",n=this.args.$textarea,a=TY.util.cursorPoint.get(n[0]);i&&(e=n.val().substring(0,a.start),o=n.val().substring(a.end),n.val(e+"["+i+"]"+o),TY.util.cursorPoint.toTextAt(n[0],n.val().length-o.length),t.isFunction(this.args.callback)&&this.args.callback(i))},bindEvents:function(){var i=this;this.args.$el.bind("click",function(){i.$emotion.is(":visible")?i.$emotion.hide():(i.setPosition(),i.$emotion.show())}),t(".emot-cont-pkg",this.$emotion).delegate("li","hover",function(i){"mouseenter"===i.type?t(this).find("img").attr("src",t(this).data("gif")):t(this).find("img").attr("src",t(this).data("img"))}),t(".emot-tab-list a",this.$emotion).bind("click",function(){t(this).hasClass("curr")||(t(this).addClass("curr").parent().siblings().find("a.curr").removeClass("curr"),t(".emot-cont-pkg",i.$emotion).html(i.createEmotPkgHtml(t(this).data("pkg"))),t(".emot-cont",i.$emotion).data("TY_util_scrollbar").update())}),t(document).bind("click.TY_ui_emotion",function(e){i.$emotion.is(":visible")&&(t(e.target).is(i.args.$el)||t(e.target).is(i.$emotion)||t.contains(i.$emotion[0],e.target)||i.$emotion.hide())}),t(window).bind("resize.TY_ui_emotion",function(){i.setPosition()}),TY_util_emotion.getVipFlag()?t(".emot-cont-pkg",this.$emotion).delegate("li","click",function(){i.args.$textarea.size()?(i.insertEmotionCode(t(this).data("code")),i.$emotion.hide()):TY.util.console("You have not defined the textarea.")}):(t(".open-vip-btn",this.$emotion).bind("click",function(){TY.loader("TY.ui.vipPay",function(){new TY.ui.vipPay({showBuy:1}),i.$emotion.hide()})}),t(".emot-cont-pkg",this.$emotion).delegate("li","click",function(){t(".open-vip-tips span").fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200)}))}})}(jQuery);